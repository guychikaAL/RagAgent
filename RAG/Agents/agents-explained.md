# RAG Agents Architecture - Complete Guide

## ğŸ¤– **What Are RAG Agents?**

RAG Agents are specialized AI components that handle different types of questions in your RAG system. Each agent has a specific role and expertise, working together to provide accurate answers.

---

## ğŸ¯ **The Three Agents**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG AGENT SYSTEM                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. ROUTER AGENT      â†’ Question Classifier            â”‚
â”‚     "Which agent should handle this?"                   â”‚
â”‚                                                         â”‚
â”‚  2. NEEDLE AGENT      â†’ Atomic Fact Extractor          â”‚
â”‚     "What is the specific value?"                       â”‚
â”‚     ğŸ”§ MCP Tools: Date calculations                     â”‚
â”‚                                                         â”‚
â”‚  3. SUMMARY AGENT     â†’ Contextual Synthesizer         â”‚
â”‚     "Explain the situation"                            â”‚
â”‚     ğŸ”§ MCP Tools: Timeline synthesis                    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **High-Level Agent Flow**

```
User Question
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: ROUTER AGENT                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚  Analyzes question type                        â”‚
â”‚  Decides: NEEDLE or SUMMARY                    â”‚
â”‚  Returns: route + confidence + reason          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                    â†“
     â†“ NEEDLE             â†“ SUMMARY
     â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2a:        â”‚  â”‚ STEP 2b:                â”‚
â”‚ NEEDLE AGENT    â”‚  â”‚ SUMMARY AGENT           â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚ â€¢ Retrieves     â”‚  â”‚ â€¢ Retrieves broad       â”‚
â”‚   atomic chunks â”‚  â”‚   context (10-15 chunks)â”‚
â”‚ â€¢ Extracts      â”‚  â”‚ â€¢ Synthesizes narrative â”‚
â”‚   single fact   â”‚  â”‚ â€¢ Combines multiple     â”‚
â”‚ â€¢ Precision     â”‚  â”‚   facts                 â”‚
â”‚   focused       â”‚  â”‚ â€¢ Recall focused        â”‚
â”‚ ğŸ”§ MCP enabled  â”‚  â”‚ ğŸ”§ MCP enabled          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                    â†“
     â†“ (if date calc)     â†“ (if date calc)
     â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: MCP TOOL (Optional)                 â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚ calculate_days_between()                    â”‚
â”‚ â€¢ LLM detects date calculation need         â”‚
â”‚ â€¢ Extracts dates from retrieved chunks      â”‚
â”‚ â€¢ Calls tool with dates                     â”‚
â”‚ â€¢ Returns exact calculation                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: FINAL ANSWER                        â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚ {                                           â”‚
â”‚   "answer": "...",                          â”‚
â”‚   "route": "NEEDLE" or "SUMMARY",           â”‚
â”‚   "confidence": 0.95,                       â”‚
â”‚   "sources": ["chunk_1", "chunk_2"],        â”‚
â”‚   "reason": "... (Used MCP: ...)" or "..."  â”‚
â”‚ }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ **Router Agent - The Classifier**

### **Purpose:**
Analyzes the user's question and decides which agent should handle it.

### **Responsibilities:**
- âœ… Question type classification
- âœ… Route decision (NEEDLE or SUMMARY)
- âœ… Confidence scoring
- âŒ NO retrieval (pure classification)
- âŒ NO answer generation

---

### **Router Agent Flow:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ROUTER AGENT                       â”‚
â”‚         (Question Classifier)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  Input: "How many days between X and Y?"       â”‚
â”‚     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Analyze Question Pattern              â”‚     â”‚
â”‚  â”‚                                        â”‚     â”‚
â”‚  â”‚ Keywords detected:                    â”‚     â”‚
â”‚  â”‚ â€¢ "how many days"                     â”‚     â”‚
â”‚  â”‚ â€¢ "between"                           â”‚     â”‚
â”‚  â”‚ â€¢ Two events (X, Y)                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Apply Routing Rules                   â”‚     â”‚
â”‚  â”‚                                        â”‚     â”‚
â”‚  â”‚ Rule 1: Specific fact â†’ NEEDLE        â”‚     â”‚
â”‚  â”‚ Rule 2: Date calculation â†’ NEEDLE     â”‚     â”‚
â”‚  â”‚ Rule 3: Multiple facts â†’ SUMMARY      â”‚     â”‚
â”‚  â”‚ Rule 4: Narrative â†’ SUMMARY           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Decision: NEEDLE                      â”‚     â”‚
â”‚  â”‚ Reason: Date calculation question     â”‚     â”‚
â”‚  â”‚ Confidence: 0.90                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                            â”‚
â”‚  Output:                                        â”‚
â”‚  {                                              â”‚
â”‚    "route": "NEEDLE",                          â”‚
â”‚    "confidence": 0.90,                         â”‚
â”‚    "reason": "Date calculation requires        â”‚
â”‚               atomic facts and MCP tool"       â”‚
â”‚  }                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **Routing Rules:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ROUTE TO NEEDLE IF:                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Specific fact/value needed                â”‚
â”‚ âœ“ Single atomic piece of information        â”‚
â”‚ âœ“ Name, number, date, identifier            â”‚
â”‚ âœ“ Date calculations (NEW!)                  â”‚
â”‚ âœ“ Questions with:                           â”‚
â”‚   â€¢ "What is..."                            â”‚
â”‚   â€¢ "Who is..."                             â”‚
â”‚   â€¢ "When did..."                           â”‚
â”‚   â€¢ "How much..." (number)                  â”‚
â”‚   â€¢ "How many days..." (date calc)          â”‚
â”‚                                             â”‚
â”‚ Examples:                                   â”‚
â”‚ â€¢ "What is Jon Mor's phone number?"         â”‚
â”‚ â€¢ "When did the accident occur?"            â”‚
â”‚ â€¢ "How many days between X and Y?"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ROUTE TO SUMMARY IF:               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Explanation/overview needed               â”‚
â”‚ âœ“ Multiple facts required                   â”‚
â”‚ âœ“ Contextual understanding                  â”‚
â”‚ âœ“ Narrative/timeline synthesis              â”‚
â”‚ âœ“ Questions with:                           â”‚
â”‚   â€¢ "Describe..."                           â”‚
â”‚   â€¢ "Explain..."                            â”‚
â”‚   â€¢ "Summarize..."                          â”‚
â”‚   â€¢ "Tell me about..."                      â”‚
â”‚   â€¢ "What happened..."                      â”‚
â”‚                                             â”‚
â”‚ Examples:                                   â”‚
â”‚ â€¢ "Describe Jon Mor's claim"                â”‚
â”‚ â€¢ "Explain what happened in the accident"   â”‚
â”‚ â€¢ "Summarize the claim timeline"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **Router Configuration:**

```python
router_agent = RouterAgent(
    model="gpt-4o-mini",
    temperature=0.0  # Deterministic classification
)
```

**Key Features:**
- ğŸ¯ **Fast**: Uses gpt-4o-mini
- ğŸ¯ **Deterministic**: Temperature=0.0 (consistent routing)
- ğŸ¯ **Lightweight**: No retrieval, pure classification
- ğŸ¯ **Confident**: Provides confidence score

---

## 2ï¸âƒ£ **Needle Agent - The Fact Extractor**

### **Purpose:**
Extracts single, atomic facts from the document with high precision.

### **Specialization:**
- âœ… Atomic fact extraction
- âœ… High precision (few, relevant chunks)
- âœ… Single-answer questions
- âœ… Date calculations (with MCP tools)
- âŒ NO guessing (returns null if not found)
- âŒ NO synthesis of multiple facts

---

### **Needle Agent Flow (with MCP):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NEEDLE AGENT                           â”‚
â”‚            (Atomic Fact Extraction)                      â”‚
â”‚                  ğŸ”§ MCP ENABLED                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Input: "How many days between Jon Mor's accident       â”‚
â”‚          and repair?"                                    â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 1: RETRIEVE CHILD CHUNKS                  â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Needle Retriever Settings:                     â”‚     â”‚
â”‚  â”‚ â€¢ top_k = 3-5 (few, precise chunks)            â”‚     â”‚
â”‚  â”‚ â€¢ similarity_threshold = 0.7-0.75 (high)       â”‚     â”‚
â”‚  â”‚ â€¢ Child chunks only (atomic facts)             â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Retrieved Chunks:                              â”‚     â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚  â”‚ â”‚ Chunk 1:                               â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ "Jon Mor, Accident Date: 2024-06-06"   â”‚    â”‚     â”‚
â”‚  â”‚ â”‚                                        â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Chunk 2:                               â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ "Repair Appointment: 2024-07-08"       â”‚    â”‚     â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 2: LLM ANALYSIS (with MCP Tools)         â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ LLM receives:                                  â”‚     â”‚
â”‚  â”‚ â€¢ Question                                     â”‚     â”‚
â”‚  â”‚ â€¢ Retrieved chunks (with dates)                â”‚     â”‚
â”‚  â”‚ â€¢ System prompt (extraction rules)             â”‚     â”‚
â”‚  â”‚ â€¢ MCP tool definitions:                        â”‚     â”‚
â”‚  â”‚   â””â”€ calculate_days_between()                  â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ LLM Decision (tool_choice="auto"):            â”‚     â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚     â”‚
â”‚  â”‚ â”‚ "I see two dates in the chunks.      â”‚      â”‚     â”‚
â”‚  â”‚ â”‚  This is a date calculation question.â”‚      â”‚     â”‚
â”‚  â”‚ â”‚  I should use the MCP tool!"         â”‚      â”‚     â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 3: MCP TOOL CALL                         â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ 1. LLM extracts dates from chunks:            â”‚     â”‚
â”‚  â”‚    start_date = "2024-06-06"                  â”‚     â”‚
â”‚  â”‚    end_date = "2024-07-08"                    â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ 2. LLM generates tool call:                   â”‚     â”‚
â”‚  â”‚    calculate_days_between(                    â”‚     â”‚
â”‚  â”‚      start_date="2024-06-06",                 â”‚     â”‚
â”‚  â”‚      end_date="2024-07-08"                    â”‚     â”‚
â”‚  â”‚    )                                          â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ 3. Tool executes (Python):                    â”‚     â”‚
â”‚  â”‚    from datetime import datetime              â”‚     â”‚
â”‚  â”‚    start = datetime(2024, 6, 6)               â”‚     â”‚
â”‚  â”‚    end = datetime(2024, 7, 8)                 â”‚     â”‚
â”‚  â”‚    diff = (end - start).days                  â”‚     â”‚
â”‚  â”‚    # Result: 32 days                          â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ 4. Tool returns:                              â”‚     â”‚
â”‚  â”‚    {                                          â”‚     â”‚
â”‚  â”‚      "success": true,                         â”‚     â”‚
â”‚  â”‚      "number_of_days": 32,                    â”‚     â”‚
â”‚  â”‚      "start_date": "2024-06-06",              â”‚     â”‚
â”‚  â”‚      "end_date": "2024-07-08",                â”‚     â”‚
â”‚  â”‚      "message": "Calculated exact difference" â”‚     â”‚
â”‚  â”‚    }                                          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 4: LLM FORMATS FINAL ANSWER              â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ LLM receives tool result and formats:         â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ "32 days"                                     â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ (NOT "about 32 days" or "approximately 32")   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  Output:                                                 â”‚
â”‚  {                                                       â”‚
â”‚    "answer": "32 days",                                 â”‚
â”‚    "confidence": 0.95,                                  â”‚
â”‚    "sources": ["chunk_1", "chunk_2"],                   â”‚
â”‚    "reason": "Found explicitly in chunk_1 and chunk_2.  â”‚
â”‚              (Used MCP: calculate_days_between)"        â”‚
â”‚              â†‘ KEY MCP INDICATOR                        â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **ğŸ”„ Auto-Merging Retrieval (Parent-Child Pattern):**

The Needle Agent uses **AutoMergingRetriever** which implements a sophisticated parent-child retrieval pattern:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         AUTO-MERGING RETRIEVAL PATTERN                   â”‚
â”‚     (How Needle Agent Finds Information)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Question: "What is the phone number in claim #5?"       â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 1: SEARCH CHILD CHUNKS (Atomic Facts)    â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Vector similarity search on CHILD chunks:      â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ ğŸ” Child Chunk Matches Found:                 â”‚     â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚  â”‚ â”‚ Child 1 (Score: 0.96):                 â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ "Officer badge ID: **7742**"           â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Parent: 15f9b9fc71c7...                â”‚    â”‚     â”‚
â”‚  â”‚ â”‚                                        â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Child 2 (Score: 1.00):                 â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ "Timeline events, Court date..."       â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Parent: 15f9b9fc71c7...                â”‚    â”‚     â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ WHY CHILD CHUNKS:                             â”‚     â”‚
â”‚  â”‚ â€¢ High precision semantic matching             â”‚     â”‚
â”‚  â”‚ â€¢ Small, focused content                       â”‚     â”‚
â”‚  â”‚ â€¢ Each child = one atomic fact                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 2: AUTO-MERGE TO PARENT CHUNKS           â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ System automatically retrieves PARENT chunks:  â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ ğŸ“¦ Parent Chunk (15f9b9fc71c7...):            â”‚     â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚  â”‚ â”‚ SECTION 1 â€“ CLAIMANT INFORMATION       â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Name: Eli Cohen                        â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Phone: (555) 100-2004  â† HAS ANSWER!  â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Account Number: ACC9900461             â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ Address: 104 Main Street...            â”‚    â”‚     â”‚
â”‚  â”‚ â”‚                                        â”‚    â”‚     â”‚
â”‚  â”‚ â”‚ [Contains both Child 1 & Child 2]      â”‚    â”‚     â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ WHY PARENT CHUNKS:                            â”‚     â”‚
â”‚  â”‚ â€¢ Complete context (full information)          â”‚     â”‚
â”‚  â”‚ â€¢ Contains answer that child didn't have       â”‚     â”‚
â”‚  â”‚ â€¢ Maintains logical boundaries                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 3: EXTRACT FROM PARENT                   â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ LLM analyzes PARENT chunk:                    â”‚     â”‚
â”‚  â”‚ Finds: "Phone: (555) 100-2004"                â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Answer: "(555) 100-2004" âœ…                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  Output:                                                 â”‚
â”‚  {                                                       â”‚
â”‚    "answer": "(555) 100-2004",                          â”‚
â”‚    "confidence": 1.00,                                  â”‚
â”‚    "chunk_hierarchy": [                                 â”‚
â”‚      {"chunk_level": "parent", "score": 1.245},         â”‚
â”‚      {"chunk_level": "child", "parent_id": "..."}       â”‚
â”‚    ]                                                     â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**The Pattern:**
```
ğŸ” Search Children (Precision) â†’ ğŸ”„ Merge to Parents (Context) â†’ âœ… Extract Answer
```

**Why This Works:**
- âœ… **Precision**: Child chunks match queries accurately
- âœ… **Context**: Parent chunks have complete information
- âœ… **Best of Both**: Precise search + full context
- âœ… **No Information Loss**: Parent always contains child content

**GUI Visualization:**
The auto-merging process is visible in the GUI under "ğŸŒ³ Auto-Merging Hierarchy" showing:
- Which child chunks matched
- Which parent chunks were returned
- Parent â†’ Child relationships

---

### **Needle Agent - Simple Fact Extraction (No MCP):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input: "What is Jon Mor's phone number?"               â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 1: RETRIEVE                               â”‚     â”‚
â”‚  â”‚ Retrieved: ["Jon Mor, phone: 555-1234"]        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 2: LLM ANALYSIS                           â”‚     â”‚
â”‚  â”‚ LLM thinks: "No date calculation needed.       â”‚     â”‚
â”‚  â”‚              Just extract the phone number."    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 3: DIRECT EXTRACTION                      â”‚     â”‚
â”‚  â”‚ Answer: "555-1234"                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  Output:                                                 â”‚
â”‚  {                                                       â”‚
â”‚    "answer": "555-1234",                                â”‚
â”‚    "confidence": 0.95,                                  â”‚
â”‚    "sources": ["chunk_1"],                              â”‚
â”‚    "reason": "Found explicitly in chunk_1"              â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **Needle Agent Configuration:**

```python
needle_agent = NeedleAgent(
    model="gpt-4o-mini",
    temperature=0.0,          # Deterministic extraction
    enable_mcp_tools=True     # ğŸ”§ MCP tools enabled!
)

# Retriever settings
needle_retriever = index_manager.get_needle_retriever(
    top_k=3,                  # Few, precise chunks
    similarity_threshold=0.75 # High threshold (quality over quantity)
)
```

**Key Features:**
- ğŸ¯ **Precise**: High threshold, few chunks
- ğŸ¯ **Atomic**: Child chunks only (single facts)
- ğŸ¯ **Deterministic**: Temperature=0.0
- ğŸ¯ **MCP-Enabled**: Handles date calculations
- ğŸ¯ **Honest**: Returns null if not found (no guessing)

---

### **Needle Agent MCP Integration:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     How MCP Works in Needle Agent          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  1. INITIALIZATION:                         â”‚
â”‚     if enable_mcp_tools:                    â”‚
â”‚       self.tools = [                        â”‚
â”‚         calculate_days_between_definition   â”‚
â”‚       ]                                     â”‚
â”‚                                             â”‚
â”‚  2. LLM INVOCATION:                         â”‚
â”‚     response = self.llm.invoke(             â”‚
â”‚       messages,                             â”‚
â”‚       tools=self.tools,      â† Tools        â”‚
â”‚       tool_choice="auto"     â† LLM decides  â”‚
â”‚     )                                       â”‚
â”‚                                             â”‚
â”‚  3. TOOL DETECTION:                         â”‚
â”‚     if response.tool_calls:                 â”‚
â”‚       # LLM decided to use tool             â”‚
â”‚       return _handle_tool_call(...)         â”‚
â”‚     else:                                   â”‚
â”‚       # Direct answer                       â”‚
â”‚       return parse_answer(...)              â”‚
â”‚                                             â”‚
â”‚  4. TOOL EXECUTION:                         â”‚
â”‚     tool_result = calculate_days_between(   â”‚
â”‚       **tool_call.arguments                 â”‚
â”‚     )                                       â”‚
â”‚                                             â”‚
â”‚  5. FINAL FORMATTING:                       â”‚
â”‚     final_answer = self.llm.invoke([        â”‚
â”‚       original_messages,                    â”‚
â”‚       tool_call,                            â”‚
â”‚       tool_result                           â”‚
â”‚     ])                                      â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3ï¸âƒ£ **Summary Agent - The Synthesizer**

### **Purpose:**
Combines multiple facts and chunks into a coherent, contextual narrative.

### **Specialization:**
- âœ… Contextual synthesis
- âœ… High recall (many chunks, comprehensive)
- âœ… Multi-fact questions
- âœ… Timeline and narrative generation
- âœ… MCP tools for precise date calculations in timelines
- âŒ NO atomic fact extraction (use Needle for that)

---

### **Summary Agent Flow:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SUMMARY AGENT                          â”‚
â”‚            (Contextual Synthesis)                        â”‚
â”‚                  ğŸ”§ MCP ENABLED                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Input: "Describe Jon Mor's claim timeline"             â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ MODE SELECTION                                 â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Two modes available:                           â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Mode A: MapReduce Query Engine                â”‚     â”‚
â”‚  â”‚   âœ… Best for complex summaries                â”‚     â”‚
â”‚  â”‚   âœ… Hierarchical summarization                â”‚     â”‚
â”‚  â”‚   âŒ NO MCP SUPPORT (yet)                      â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Mode B: Retriever + Synthesis                 â”‚     â”‚
â”‚  â”‚   âœ… Direct retrieval + LLM synthesis          â”‚     â”‚
â”‚  â”‚   âœ… MCP SUPPORT ENABLED                       â”‚     â”‚
â”‚  â”‚   âš ï¸  Less sophisticated than MapReduce        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                           â†“                        â”‚
â”‚  Mode A (Current)          Mode B (MCP-enabled)         â”‚
â”‚     â†“                           â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MapReduce Mode   â”‚    â”‚ Retriever Mode           â”‚  â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚    â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚
â”‚  â”‚                  â”‚    â”‚                          â”‚  â”‚
â”‚  â”‚ 1. Retrieve 15   â”‚    â”‚ 1. Retrieve 10-15 parent â”‚  â”‚
â”‚  â”‚    chunks        â”‚    â”‚    chunks                â”‚  â”‚
â”‚  â”‚                  â”‚    â”‚                          â”‚  â”‚
â”‚  â”‚ 2. MAP phase:    â”‚    â”‚ 2. LLM synthesis         â”‚  â”‚
â”‚  â”‚    â€¢ Summarize   â”‚    â”‚    (with MCP tools)      â”‚  â”‚
â”‚  â”‚      each chunk  â”‚    â”‚                          â”‚  â”‚
â”‚  â”‚      individuallyâ”‚    â”‚    LLM sees:             â”‚  â”‚
â”‚  â”‚                  â”‚    â”‚    â€¢ All chunks          â”‚  â”‚
â”‚  â”‚ 3. REDUCE phase: â”‚    â”‚    â€¢ MCP tool def        â”‚  â”‚
â”‚  â”‚    â€¢ Combine     â”‚    â”‚                          â”‚  â”‚
â”‚  â”‚      summaries   â”‚    â”‚    If date calc needed:  â”‚  â”‚
â”‚  â”‚      hierarchic. â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚                  â”‚    â”‚    â”‚ Call MCP tool  â”‚   â”‚  â”‚
â”‚  â”‚ 4. FINAL summary â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                  â”‚    â”‚                          â”‚  â”‚
â”‚  â”‚ âŒ No MCP tools  â”‚    â”‚ 3. Format comprehensive  â”‚  â”‚
â”‚  â”‚                  â”‚    â”‚    answer (with tool     â”‚  â”‚
â”‚  â”‚                  â”‚    â”‚    results if used)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â†“                           â†“                        â”‚
â”‚  Output:                                                 â”‚
â”‚  {                                                       â”‚
â”‚    "answer": "Jon Mor's claim began on June 6, 2024..." â”‚
â”‚    "confidence": 0.85,                                  â”‚
â”‚    "sources": ["chunk_1", ..., "chunk_15"],            â”‚
â”‚    "reason": "MapReduce hierarchical summarization"    â”‚
â”‚             or "(Used MCP: calculate_days_between)"    â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **ğŸ—ºï¸ Map-Reduce Detailed Process (tree_summarize):**

The Summary Agent uses **Map-Reduce** (via LlamaIndex's `tree_summarize`) to handle many chunks efficiently:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MAP-REDUCE SUMMARIZATION PATTERN                 â”‚
â”‚     (How Summary Agent Processes Many Chunks)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Question: "Summarize claim number 10"                   â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 1: RETRIEVE (30 chunks retrieved)        â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Vector similarity search returns 30 chunks:    â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Chunk 1: "Rachel Stern, claim #10..."         â”‚     â”‚
â”‚  â”‚ Chunk 2: "Accident date 2024-03-18..."        â”‚     â”‚
â”‚  â”‚ Chunk 3: "Vehicle: Honda Civic 2020..."       â”‚     â”‚
â”‚  â”‚ Chunk 4: "Repair estimate: $2,150..."         â”‚     â”‚
â”‚  â”‚ ...                                            â”‚     â”‚
â”‚  â”‚ Chunk 30: "Court date: 2024-09-15..."         â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ WHY 30 CHUNKS:                                â”‚     â”‚
â”‚  â”‚ â€¢ Comprehensive coverage of entire claim       â”‚     â”‚
â”‚  â”‚ â€¢ Map-Reduce can handle it efficiently!        â”‚     â”‚
â”‚  â”‚ â€¢ Traditional RAG would overflow context       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 2: MAP (Summarize Each Chunk)            â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Each chunk â†’ 2-3 sentence summary:            â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Chunk 1 â†’ Summary 1 (85 tokens):              â”‚     â”‚
â”‚  â”‚   "Rachel Stern filed claim #10. She drives   â”‚     â”‚
â”‚  â”‚    a Honda Civic. The incident occurred on    â”‚     â”‚
â”‚  â”‚    March 18, 2024 during foggy conditions."   â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Chunk 2 â†’ Summary 2 (92 tokens):              â”‚     â”‚
â”‚  â”‚   "The accident was a rear-end collision      â”‚     â”‚
â”‚  â”‚    at an intersection. Minor injuries were    â”‚     â”‚
â”‚  â”‚    reported. Police report was filed."        â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Chunk 3 â†’ Summary 3 (78 tokens):              â”‚     â”‚
â”‚  â”‚   "Vehicle damage includes rear bumper and    â”‚     â”‚
â”‚  â”‚    trunk. Estimated repair cost is $2,150.    â”‚     â”‚
â”‚  â”‚    Parts needed include bumper assembly."     â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ ... (27 more summaries)                       â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Chunk 30 â†’ Summary 30 (88 tokens)             â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ RESULT: 30 individual summaries               â”‚     â”‚
â”‚  â”‚         (~2,500 tokens total)                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 3: REDUCE Level 1 (30 â†’ 10)              â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Group summaries and combine:                  â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Group A (Summaries 1-3) â†’ Combined A:         â”‚     â”‚
â”‚  â”‚   "Rachel Stern's claim #10 involves a rear-  â”‚     â”‚
â”‚  â”‚    end collision on March 18, 2024. The       â”‚     â”‚
â”‚  â”‚    Honda Civic sustained rear damage with     â”‚     â”‚
â”‚  â”‚    repair cost of $2,150. Foggy conditions    â”‚     â”‚
â”‚  â”‚    were present during the incident."         â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Group B (Summaries 4-6) â†’ Combined B          â”‚     â”‚
â”‚  â”‚ Group C (Summaries 7-9) â†’ Combined C          â”‚     â”‚
â”‚  â”‚ ... (7 more groups)                           â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ RESULT: 10 combined summaries                 â”‚     â”‚
â”‚  â”‚         (~1,200 tokens total)                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 4: REDUCE Level 2 (10 â†’ 3)               â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Further combine into thematic summaries:      â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Theme 1 - Incident Details:                   â”‚     â”‚
â”‚  â”‚   "Complete description of the accident..."   â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Theme 2 - Damage & Costs:                     â”‚     â”‚
â”‚  â”‚   "Vehicle damage assessment and repair..."   â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ Theme 3 - Administrative:                     â”‚     â”‚
â”‚  â”‚   "Claim processing, court dates, status..."  â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ RESULT: 3 thematic summaries                  â”‚     â”‚
â”‚  â”‚         (~500 tokens total)                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ STEP 5: FINAL SYNTHESIS (3 â†’ 1)               â”‚     â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚     â”‚
â”‚  â”‚ Combine all themes into final comprehensive   â”‚     â”‚
â”‚  â”‚ answer that addresses the original question:  â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ "Claim #10 filed by Rachel Stern involves a   â”‚     â”‚
â”‚  â”‚  rear-end collision that occurred on March    â”‚     â”‚
â”‚  â”‚  18, 2024 at an intersection during foggy     â”‚     â”‚
â”‚  â”‚  conditions. The incident damaged the rear    â”‚     â”‚
â”‚  â”‚  of her 2020 Honda Civic, with repair costs   â”‚     â”‚
â”‚  â”‚  estimated at $2,150. A police report was     â”‚     â”‚
â”‚  â”‚  filed, and the claim is currently open with  â”‚     â”‚
â”‚  â”‚  a court date scheduled for September 15,     â”‚     â”‚
â”‚  â”‚  2024. The damage includes the rear bumper    â”‚     â”‚
â”‚  â”‚  and trunk assembly requiring replacement."   â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚ RESULT: Comprehensive final answer            â”‚     â”‚
â”‚  â”‚         (~200 tokens)                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚     â†“                                                     â”‚
â”‚  Output:                                                 â”‚
â”‚  {                                                       â”‚
â”‚    "answer": "[Final comprehensive summary]",           â”‚
â”‚    "confidence": 0.85,                                  â”‚
â”‚    "sources": [30 chunk IDs],                           â”‚
â”‚    "map_reduce_steps": {                                â”‚
â”‚      "total_chunks": 30,                                â”‚
â”‚      "process": [                                       â”‚
â”‚        "MAP: 30 chunks â†’ 30 summaries",                 â”‚
â”‚        "REDUCE L1: 30 â†’ 10 combined",                   â”‚
â”‚        "REDUCE L2: 10 â†’ 3 themed",                      â”‚
â”‚        "FINAL: Comprehensive answer"                    â”‚
â”‚      ]                                                   â”‚
â”‚    }                                                     â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**The Pattern:**
```
ğŸ“¥ Retrieve 30 chunks â†’ 
ğŸ“ MAP (30 â†’ 30 summaries) â†’ 
ğŸ”„ REDUCE L1 (30 â†’ 10) â†’ 
ğŸ”„ REDUCE L2 (10 â†’ 3) â†’ 
âœ… FINAL (1 comprehensive answer)
```

**Why Map-Reduce is Better Than Simple Concatenation:**

| Aspect | Simple Concatenation | Map-Reduce |
|--------|---------------------|------------|
| **Chunks** | 5-10 max | 30+ chunks âœ… |
| **Context** | Overflows with many chunks | Hierarchical processing âœ… |
| **Quality** | Misses information | Systematic coverage âœ… |
| **Redundancy** | Lots of duplicate info | Removes redundancy âœ… |
| **Structure** | Chaotic | Organized by themes âœ… |

**GUI Visualization:**
The map-reduce process is visible in the GUI under "ğŸ—ºï¸ Map-Reduce Process" showing:
- Total chunks processed
- MAP step inputs (sample)
- REDUCE hierarchical levels
- Final synthesis step

---

### **Summary Agent Configuration:**

```python
summary_agent = SummaryAgent(
    model="gpt-4o-mini",
    temperature=0.2,          # Slightly creative for synthesis
    enable_mcp_tools=True     # ğŸ”§ MCP tools enabled!
)

# MapReduce Query Engine (current setup)
map_reduce_engine = index_manager.get_map_reduce_query_engine(
    top_k=30                  # Many chunks for comprehensive context
                              # Map-Reduce can handle 30+ chunks efficiently!
)

# OR: Retriever mode (MCP-enabled)
summary_retriever = index_manager.get_summary_retriever(
    top_k=15,
    similarity_threshold=0.5  # Lower threshold (recall > precision)
)
```

**Key Features:**
- ğŸ¯ **Comprehensive**: Retrieves many chunks (10-15)
- ğŸ¯ **Contextual**: Synthesizes multiple facts
- ğŸ¯ **Narrative**: Generates paragraph-length answers
- ğŸ¯ **MCP-Aware**: Can use date tools in Retriever mode
- âš ï¸ **Limitation**: MapReduce doesn't support MCP yet

---

## ğŸ”§ **MCP Tool: calculate_days_between**

### **Purpose:**
Provides deterministic, exact date calculations because LLMs are bad at date arithmetic.

---

### **MCP Tool Flow:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MCP TOOL: calculate_days_between               â”‚
â”‚              (Deterministic Date Calculator)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  WHY THIS EXISTS:                                        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”       â”‚
â”‚  âŒ LLMs are BAD at date arithmetic                     â”‚
â”‚     â€¢ Forget leap years                                 â”‚
â”‚     â€¢ Get month boundaries wrong                        â”‚
â”‚     â€¢ Give approximate answers ("about 30 days")        â”‚
â”‚  âœ… External tool = precise, verifiable, auditable      â”‚
â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  TOOL DEFINITION:                                        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”       â”‚
â”‚  {                                                       â”‚
â”‚    "type": "function",                                  â”‚
â”‚    "function": {                                        â”‚
â”‚      "name": "calculate_days_between",                 â”‚
â”‚      "description": "Calculate exact number of days    â”‚
â”‚                     between two ISO dates (YYYY-MM-DD)",â”‚
â”‚      "parameters": {                                    â”‚
â”‚        "type": "object",                               â”‚
â”‚        "properties": {                                 â”‚
â”‚          "start_date": {                              â”‚
â”‚            "type": "string",                          â”‚
â”‚            "description": "Start date (YYYY-MM-DD)"   â”‚
â”‚          },                                           â”‚
â”‚          "end_date": {                                â”‚
â”‚            "type": "string",                          â”‚
â”‚            "description": "End date (YYYY-MM-DD)"     â”‚
â”‚          }                                            â”‚
â”‚        },                                             â”‚
â”‚        "required": ["start_date", "end_date"]        â”‚
â”‚      }                                                â”‚
â”‚    }                                                  â”‚
â”‚  }                                                    â”‚
â”‚                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  EXECUTION FLOW:                                         â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”       â”‚
â”‚                                                          â”‚
â”‚  Step 1: LLM Detects Need                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Question: "How many days between X     â”‚             â”‚
â”‚  â”‚            and Y?"                     â”‚             â”‚
â”‚  â”‚                                        â”‚             â”‚
â”‚  â”‚ LLM thinks: "This is a date            â”‚             â”‚
â”‚  â”‚             calculation. I should      â”‚             â”‚
â”‚  â”‚             use the tool!"             â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚     â†“                                                     â”‚
â”‚  Step 2: Extract Dates from Context                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Retrieved chunks contain:              â”‚             â”‚
â”‚  â”‚ â€¢ "Accident: 2024-06-06"               â”‚             â”‚
â”‚  â”‚ â€¢ "Repair: 2024-07-08"                 â”‚             â”‚
â”‚  â”‚                                        â”‚             â”‚
â”‚  â”‚ LLM extracts:                          â”‚             â”‚
â”‚  â”‚ â€¢ start_date = "2024-06-06"            â”‚             â”‚
â”‚  â”‚ â€¢ end_date = "2024-07-08"              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚     â†“                                                     â”‚
â”‚  Step 3: Generate Tool Call                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ calculate_days_between(                â”‚             â”‚
â”‚  â”‚   start_date="2024-06-06",             â”‚             â”‚
â”‚  â”‚   end_date="2024-07-08"                â”‚             â”‚
â”‚  â”‚ )                                      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚     â†“                                                     â”‚
â”‚  Step 4: Tool Executes (Python)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ from datetime import datetime          â”‚             â”‚
â”‚  â”‚                                        â”‚             â”‚
â”‚  â”‚ start = datetime.fromisoformat(        â”‚             â”‚
â”‚  â”‚   "2024-06-06"                         â”‚             â”‚
â”‚  â”‚ )                                      â”‚             â”‚
â”‚  â”‚ end = datetime.fromisoformat(          â”‚             â”‚
â”‚  â”‚   "2024-07-08"                         â”‚             â”‚
â”‚  â”‚ )                                      â”‚             â”‚
â”‚  â”‚                                        â”‚             â”‚
â”‚  â”‚ difference = (end - start).days        â”‚             â”‚
â”‚  â”‚ # Result: 32                           â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚     â†“                                                     â”‚
â”‚  Step 5: Tool Returns Result                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ {                                      â”‚             â”‚
â”‚  â”‚   "success": true,                     â”‚             â”‚
â”‚  â”‚   "number_of_days": 32,                â”‚             â”‚
â”‚  â”‚   "start_date": "2024-06-06",          â”‚             â”‚
â”‚  â”‚   "end_date": "2024-07-08",            â”‚             â”‚
â”‚  â”‚   "calculation_type": "exact",         â”‚             â”‚
â”‚  â”‚   "message": "Calculated exact         â”‚             â”‚
â”‚  â”‚               difference: 32 days"     â”‚             â”‚
â”‚  â”‚ }                                      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚     â†“                                                     â”‚
â”‚  Step 6: LLM Formats Final Answer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ "32 days"                              â”‚             â”‚
â”‚  â”‚                                        â”‚             â”‚
â”‚  â”‚ (NOT "about 32 days" or                â”‚             â”‚
â”‚  â”‚      "approximately 32 days")          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **MCP Tool Features:**

```
âœ… WHAT IT DOES:
   â€¢ Exact date arithmetic
   â€¢ Handles leap years automatically
   â€¢ Month boundary calculations
   â€¢ Timezone-aware (ISO 8601)
   â€¢ Returns structured results

âŒ WHAT IT DOESN'T DO:
   â€¢ Approximate calculations
   â€¢ Guess missing dates
   â€¢ Use external knowledge
   â€¢ Require internet access

ğŸ”§ ERROR HANDLING:
   If invalid date format:
   {
     "success": false,
     "error": "Invalid date format: ...",
     "expected_format": "YYYY-MM-DD (ISO 8601)"
   }

ğŸ¯ ADVANTAGES OVER LLM:
   â€¢ Deterministic (same input â†’ same output)
   â€¢ Verifiable (can check calculation)
   â€¢ Precise (no rounding or approximation)
   â€¢ Auditable (logs tool usage)
   â€¢ Transparent (shows in reason field)
```

---

## ğŸ“Š **Complete Question Flow Examples**

### **Example 1: Simple Fact (No MCP)**

```
User: "What is Jon Mor's phone number?"
     â†“
Router: {
  "route": "NEEDLE",
  "confidence": 1.0,
  "reason": "Specific fact request"
}
     â†“
Needle Agent:
  1. Retrieve: ["Jon Mor, phone: 555-1234"]
  2. LLM: "No date calculation needed"
  3. Extract: "555-1234"
     â†“
Final Answer: {
  "answer": "555-1234",
  "route": "NEEDLE",
  "confidence": 0.95,
  "sources": ["chunk_1"],
  "reason": "Found explicitly in chunk_1"
}
```

---

### **Example 2: Date Calculation (WITH MCP)**

```
User: "How many days between Jon Mor's accident and repair?"
     â†“
Router: {
  "route": "NEEDLE",
  "confidence": 0.90,
  "reason": "Date calculation question requires 
            atomic facts and MCP tool"
}
     â†“
Needle Agent:
  1. Retrieve: [
       "Jon Mor, Accident: 2024-06-06",
       "Repair appointment: 2024-07-08"
     ]
  2. LLM detects: "Date calculation needed!"
  3. MCP Tool Call:
     calculate_days_between(
       start_date="2024-06-06",
       end_date="2024-07-08"
     )
     â†’ Returns: 32 days
  4. LLM formats: "32 days"
     â†“
Final Answer: {
  "answer": "32 days",
  "route": "NEEDLE",
  "confidence": 0.95,
  "sources": ["chunk_1", "chunk_4"],
  "reason": "Found explicitly in chunk_1 and chunk_4. 
            (Used MCP: calculate_days_between)"
            â†‘ MCP INDICATOR
}
```

---

### **Example 3: Summary Question (MapReduce, No MCP)**

```
User: "Describe Jon Mor's claim timeline"
     â†“
Router: {
  "route": "SUMMARY",
  "confidence": 1.0,
  "reason": "Narrative description requiring 
            multiple facts and context"
}
     â†“
Summary Agent (MapReduce Mode):
  1. Retrieve: 15 chunks about Jon Mor
  2. MAP: Summarize each chunk individually
  3. REDUCE: Combine summaries hierarchically
  4. FINAL: Comprehensive timeline narrative
     â†“
Final Answer: {
  "answer": "Jon Mor's claim began on June 6, 2024, 
            when his vehicle was involved in an 
            accident at the intersection of Main St 
            and Oak Ave. The initial report documented 
            damage to the front bumper and headlight. 
            A repair appointment was scheduled for 
            July 8, 2024. The total estimated cost 
            was $2,500...",
  "route": "SUMMARY",
  "confidence": 0.85,
  "sources": ["chunk_1", ..., "chunk_15"],
  "reason": "MapReduce hierarchical summarization 
            of 15 chunks"
}
```

---

## ğŸ¯ **Agent Comparison Table**

| Aspect | Router | Needle | Summary |
|--------|--------|--------|---------|
| **Purpose** | Classify question | Extract atomic fact | Synthesize context |
| **Retrieval** | âŒ No | âœ… Yes (3-5 chunks) | âœ… Yes (10-15 chunks) |
| **LLM Model** | gpt-4o-mini | gpt-4o-mini | gpt-4o-mini |
| **Temperature** | 0.0 | 0.0 | 0.2 |
| **MCP Support** | âŒ No | âœ… Yes | âš ï¸ Partial |
| **Chunk Type** | N/A | Child (atomic) | Parent (context) |
| **Threshold** | N/A | High (0.75) | Low (0.5) |
| **Focus** | Classification | Precision | Recall |
| **Output** | Route decision | Single fact | Narrative |
| **Guessing** | N/A | âŒ Never | âœ… Allowed |
| **Use Cases** | Every query | "What is...", "When...", "How many days..." | "Describe...", "Explain...", "Summarize..." |

---

## ğŸ”„ **Agent Orchestration**

### **How Agents Work Together:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ORCHESTRATOR                     â”‚
â”‚        (Coordinates All Agents)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  1. Receives user question                  â”‚
â”‚     â†“                                        â”‚
â”‚  2. Calls Router Agent                      â”‚
â”‚     â†’ Gets route decision                    â”‚
â”‚     â†“                                        â”‚
â”‚  3. Injects appropriate retriever           â”‚
â”‚     â€¢ Needle â†’ Needle retriever             â”‚
â”‚     â€¢ Summary â†’ MapReduce engine            â”‚
â”‚     â†“                                        â”‚
â”‚  4. Calls selected agent                    â”‚
â”‚     â†’ Gets answer + metadata                 â”‚
â”‚     â†“                                        â”‚
â”‚  5. Returns complete result                 â”‚
â”‚     â€¢ Answer                                â”‚
â”‚     â€¢ Route                                 â”‚
â”‚     â€¢ Confidence                            â”‚
â”‚     â€¢ Sources                               â”‚
â”‚     â€¢ Reason (with MCP info if used)        â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **Orchestrator Code:**

```python
# Initialize agents
router = RouterAgent(model="gpt-4o-mini", temperature=0.0)
needle = NeedleAgent(
    model="gpt-4o-mini", 
    temperature=0.0,
    enable_mcp_tools=True  # âœ… MCP enabled
)
summary = SummaryAgent(
    model="gpt-4o-mini", 
    temperature=0.2,
    enable_mcp_tools=True  # âœ… MCP enabled
)

# Create orchestrator
orchestrator = Orchestrator(
    router_agent=router,
    needle_agent=needle,
    summary_agent=summary,
    needle_retriever=needle_retriever,
    map_reduce_query_engine=map_reduce_engine
)

# Run query
result = orchestrator.run("How many days between X and Y?")
# Returns complete result with MCP indicator if used
```

---

## âœ… **Summary: Agent Roles**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AGENT RESPONSIBILITIES                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ROUTER AGENT                                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  â€¢ Question type classification                         â”‚
â”‚  â€¢ Route decision (NEEDLE or SUMMARY)                   â”‚
â”‚  â€¢ Confidence scoring                                   â”‚
â”‚  â€¢ NO retrieval, NO answer generation                   â”‚
â”‚                                                         â”‚
â”‚  NEEDLE AGENT                                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  â€¢ Atomic fact extraction                               â”‚
â”‚  â€¢ High precision retrieval (3-5 chunks)                â”‚
â”‚  â€¢ Date calculations (MCP tools)                        â”‚
â”‚  â€¢ Returns null if not found (no guessing)              â”‚
â”‚  â€¢ Child chunks only                                    â”‚
â”‚                                                         â”‚
â”‚  SUMMARY AGENT                                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  â€¢ Contextual synthesis                                 â”‚
â”‚  â€¢ High recall retrieval (10-15 chunks)                 â”‚
â”‚  â€¢ Multi-fact narratives                                â”‚
â”‚  â€¢ Timeline generation (MCP tools in Retriever mode)    â”‚
â”‚  â€¢ Parent chunks (broader context)                      â”‚
â”‚                                                         â”‚
â”‚  MCP TOOL: calculate_days_between                       â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  â€¢ Deterministic date calculations                      â”‚
â”‚  â€¢ Exact arithmetic (no approximations)                 â”‚
â”‚  â€¢ Transparent (shows in reason field)                  â”‚
â”‚  â€¢ Verifiable and auditable                             â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **Key Concepts**

### **1. Why Multiple Agents?**

```
Single-agent approach:
âŒ Jack of all trades, master of none
âŒ Suboptimal retrieval strategies
âŒ Confused on edge cases

Multi-agent approach:
âœ… Specialized expertise
âœ… Optimized retrieval per question type
âœ… Clear responsibilities
âœ… Better overall quality
```

---

### **2. Why MCP Tools?**

```
LLM-only approach:
âŒ "About 30 days" (approximate)
âŒ Forgets leap years
âŒ Can't verify calculation
âŒ Inconsistent results

MCP Tool approach:
âœ… "32 days" (exact)
âœ… Handles leap years automatically
âœ… Verifiable via logs
âœ… Deterministic (same input â†’ same output)
âœ… Transparent (shows in reason)
```

---

### **3. Router Updates for MCP**

```
OLD routing:
"How many days between X and Y?"
   â†’ SUMMARY (treated as narrative question)
   â†’ MapReduce (no MCP support)
   â†’ LLM guesses: "about 30 days" âŒ

NEW routing:
"How many days between X and Y?"
   â†’ NEEDLE (recognized as date calculation)
   â†’ MCP tool: calculate_days_between()
   â†’ Exact result: "32 days" âœ…
```

---

## ğŸ“ **Files Reference**

| File | Purpose |
|------|---------|
| `router_agent.py` | Question classifier |
| `needle_agent.py` | Atomic fact extractor (MCP-enabled) |
| `summary_agent.py` | Context synthesizer (MCP-enabled) |
| `../Orchestration/orchestrator.py` | Agent coordinator |
| `../../mcp_tools/date_calculator.py` | MCP date tool |

---

## ğŸš€ **Usage Examples**

### **In CLI (main.py):**

```bash
python main.py

# MCP-enabled queries:
> How many days between Jon Mor's accident and repair?
âœ… Route: NEEDLE
âœ… Answer: 32 days
âœ… Reason: Found in chunks. (Used MCP: calculate_days_between)

# Regular queries:
> What is Jon Mor's phone number?
âœ… Route: NEEDLE
âœ… Answer: 555-1234
âœ… Reason: Found explicitly in chunk_1
```

### **In GUI (app/gui_app.py):**

```bash
streamlit run app/gui_app.py

# When MCP is used, you'll see:
ğŸ”§ MCP Tool Used: Date calculation performed 
   with external tool for accuracy

MCP Tool: âœ… Used
```

---

**Built for RagAgentv2 - Auto Claims RAG System** ğŸš—ğŸ¤–



RAG/Agents/agents-explained.md
â”œâ”€ ğŸ¤– What Are RAG Agents?
â”œâ”€ ğŸ¯ The Three Agents (Overview)
â”œâ”€ ğŸ“Š High-Level Agent Flow
â”‚
â”œâ”€ 1ï¸âƒ£ ROUTER AGENT
â”‚   â”œâ”€ Purpose & Responsibilities
â”‚   â”œâ”€ Flow Diagram
â”‚   â”œâ”€ Routing Rules (NEEDLE vs SUMMARY)
â”‚   â””â”€ Configuration
â”‚
â”œâ”€ 2ï¸âƒ£ NEEDLE AGENT
â”‚   â”œâ”€ Purpose & Specialization
â”‚   â”œâ”€ Flow with MCP Integration
â”‚   â”œâ”€ Flow without MCP (Simple Facts)
â”‚   â”œâ”€ Configuration
â”‚   â””â”€ MCP Integration Details
â”‚
â”œâ”€ 3ï¸âƒ£ SUMMARY AGENT
â”‚   â”œâ”€ Purpose & Specialization
â”‚   â”œâ”€ Flow (MapReduce vs Retriever modes)
â”‚   â”œâ”€ Configuration
â”‚   â””â”€ MCP Support Status
â”‚
â”œâ”€ ğŸ”§ MCP TOOL: calculate_days_between
â”‚   â”œâ”€ Why It Exists
â”‚   â”œâ”€ Tool Definition
â”‚   â”œâ”€ Complete Execution Flow
â”‚   â”œâ”€ Features & Error Handling
â”‚   â””â”€ Advantages Over LLM
â”‚
â”œâ”€ ğŸ“Š Complete Question Flow Examples
â”‚   â”œâ”€ Example 1: Simple Fact (No MCP)
â”‚   â”œâ”€ Example 2: Date Calculation (WITH MCP)
â”‚   â””â”€ Example 3: Summary Question (MapReduce)
â”‚
â”œâ”€ ğŸ¯ Agent Comparison Table
â”œâ”€ ğŸ”„ Agent Orchestration
â”œâ”€ âœ… Summary: Agent Roles
â”œâ”€ ğŸ“ Key Concepts
â”œâ”€ ğŸ“ Files Reference
â””â”€ ğŸš€ Usage Examples (CLI & GUI)